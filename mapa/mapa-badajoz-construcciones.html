<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapa de Badajoz - Edificios por año</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      .leaflet-tile {
        filter: grayscale(1) contrast(0.5) brightness(1.3);
      }
      .leaflet-interactive:focus {
        outline: none;
        box-shadow: none;
      }
      .voc-map-contenedor {
        width: 100%;
        height: 600px;
      }
      #voc-map {
        height: 600px;
        width: 100%;
        position: relative;
        z-index: 1;
      }
      @media (max-width: 699px) {
        #voc-map {
          height: 500px;
        }
      }
      .leaflet-tooltip {
        min-width: 150px;
        max-width: 300px;
        word-wrap: break-word;
        white-space: normal;
        font-size: 14px;
        font-family: "Guardian TextSans Regular", sans-serif;
      }
      .leaflet-tooltip .highlighted {
        font-family: "Guardian TextSans Medium", sans-serif;
        font-weight: bold;
      }
      .leaflet-container {
        font-family: "Guardian TextSans Regular", sans-serif;
      }
      .leaflet-bar {
        background: white;
        border-radius: 4px;
        border: 1px solid #969594;
      }
      .leaflet-bar a {
        background-color: white;
        text-align: center;
        cursor: pointer;
        color: #202020;
      }
      .leaflet-bar a:hover {
        background-color: #f0f0f0;
      }
      .leaflet-reset-icon svg {
        width: 24px;
        height: 24px;
      }
      .legend {
        background: white;
        padding: 10px;
        line-height: 18px;
        color: #555;
        font-size: 14px;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
      }
      #buscador {
        width: 70%;
        padding: 5px;
      }
      #buscarBtn {
        padding: 5px;
      }
    </style>
  </head>
  <body>
    <div class="voc-map-contenedor">
      <div style="margin-bottom: 10px">
        <input
          type="text"
          id="buscador"
          placeholder="Calle y número, ej: Santa Marina 5"
        />
        <button id="buscarBtn">Buscar</button>
      </div>
      <div id="voc-map"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      const map = L.map("voc-map",
        {
          center: [38.8794, -6.9707], // Coordenadas de Badajoz
          zoom: 13,
          preferCanvas: true, // Mejor rendimiento para muchos elementos :cite[8]
        }
      );
      let geojson = null;
      let initialCoordinates = null;

      function getColor(year) {
        if (year === 0) return "#9b9b9b";
        else if (year >= 1 && year <= 1800) return "#ffffb2";
        else if (year <= 1899) return "#fed976";
        else if (year <= 1920) return "#feb24c";
        else if (year <= 1940) return "#fd8d3c";
        else if (year <= 1969) return "#fc4e2a";
        else if (year <= 1999) return "#f03b20";
        else if (year <= 2008) return "#bd0026";
        else if (year <= 2020) return "#800026";
        else if (year <= 2025) return "#55001a";
        else return "#000000";
      }

      function style(feature) {
        const year = parseInt(feature.properties.FECHAALTA);
        return {
          fillColor: getColor(year),
          weight: 1,
          opacity: 1,
          color: "#333",
          fillOpacity: 0.7,
        };
      }

      function highlightFeature(e) {
        const layer = e.target;
        layer.setStyle({
          weight: 2,
          color: "#000",
          fillOpacity: 0.9,
        });
        layer.bringToFront();
      }

      function resetHighlight(e) {
        if (geojson) geojson.resetStyle(e.target);
      }

      function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
      }

      function onEachFeature(feature, layer) {
        if (feature.properties) {
          const popupContent = `
            <div>
                <span class='highlighted'>Calle:</span> ${feature.properties.CALLE}<br>
                <span class='highlighted'>Número:</span> ${feature.properties.NUMERO}<br>
                <span class='highlighted'>Año de construcción:</span> ${feature.properties.FECHAALTA}<br>
                <span class='highlighted'>Metros cuadrados:</span> ${feature.properties.AREA}
            </div>`;
          layer.bindPopup(popupContent);
        }
        layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: zoomToFeature,
        });
      }

      function loadGeoJSON(url) {
        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            geojson = L.geoJSON(data, {
              style: style,
              onEachFeature: onEachFeature,
            }).addTo(map);

            // map.fitBounds(geojson.getBounds());
            initialCoordinates = map.getCenter();
          })
          .catch((err) => console.error("Error al cargar GeoJSON:", err));
      }

      function addLegend() {
        const legend = L.control({ position: "bottomleft" });
        legend.onAdd = function () {
          const div = L.DomUtil.create("div", "legend");
          const grades = [
            "0",
            "1-1800",
            "1800-1899",
            "1900-1920",
            "1921-1940",
            "1941-1969",
            "1970-1999",
            "2000-2008",
            "2009-2020",
            "2021-2025",
          ];
          grades.forEach((grade) => {
            let year;
            switch (grade) {
              case "0":
                year = 0;
                break;
              case "1-1800":
                year = 1800;
                break;
              case "1800-1899":
                year = 1899;
                break;
              case "1900-1920":
                year = 1920;
                break;
              case "1921-1940":
                year = 1940;
                break;
              case "1941-1969":
                year = 1969;
                break;
              case "1970-1999":
                year = 1999;
                break;
              case "2000-2008":
                year = 2008;
                break;
              case "2009-2020":
                year = 2020;
                break;
              case "2021-2025":
                year = 2025;
                break;
            }
            div.innerHTML += `<i style="background:${getColor(
              year
            )}"></i> ${grade}<br>`;
          });
          return div;
        };
        legend.addTo(map);
      }

      function addResetButton() {
        const resetButton = L.control({ position: "bottomright" });
        resetButton.onAdd = function (map) {
          const div = L.DomUtil.create("div", "leaflet-bar");
          div.innerHTML = `
            <a href="#" class="leaflet-reset-icon" style="display:flex;justify-content:center;align-items:center;">
                <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 24.0009V16.0009H24V19.0009H19V24.0009H16ZM5 24.0009V19.0009H0V16.0009H8V24.0009H5ZM16 8.00586V0.00585938H19V5.00586H24V8.00586H16ZM8 8.00586H0V5.00586H5V0.00585938H8V8.00586Z" fill="#202020"/>
                </svg>
            </a>`;
          div.firstChild.onclick = function (e) {
            e.preventDefault();
            if (geojson) map.fitBounds(geojson.getBounds());
            geojson.eachLayer((layer) => geojson.resetStyle(layer));
          };
          return div;
        };
        resetButton.addTo(map);
      }

      function normalizarTexto(texto) {
        return texto
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .trim();
      }

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

    //   loadGeoJSON(
    //     "https://raw.githubusercontent.com/ahorrillo/Mapas/refs/heads/main/p04/parcelas_actualizado_min.json"
    //   );
      loadGeoJSON(
        "parcelas.geojson"
      );

      addLegend();

      addResetButton();

      document.getElementById("buscarBtn").addEventListener("click", () => {
        const input = normalizarTexto(
          document.getElementById("buscador").value
        );
        if (!geojson || !input) return;
        geojson.eachLayer((layer) => geojson.resetStyle(layer));

        let encontrado = false;
        let soloCalle = false;
        geojson.eachLayer((layer) => {
          const calle = normalizarTexto(layer.feature.properties.CALLE || "");
          const numero = layer.feature.properties.NUMERO?.toString() || "";
          if (input === calle + " " + numero) {
            map.fitBounds(layer.getBounds());
            layer.openPopup();
            layer.setStyle({ weight: 3, color: "#0000ff", fillOpacity: 0.9 });
            encontrado = true;
          }
        });
        if (!encontrado) {
          geojson.eachLayer((layer) => {
            const calle = normalizarTexto(layer.feature.properties.CALLE || "");
            if (input === calle) {
              map.fitBounds(layer.getBounds());
              layer.openPopup();
              layer.setStyle({ weight: 3, color: "#0000ff", fillOpacity: 0.9 });
              soloCalle = true;
            }
          });
        }
        if (!encontrado && !soloCalle) {
          alert("No se encontró la dirección o calle.");
        }
      });
    </script>
  </body>
</html>
